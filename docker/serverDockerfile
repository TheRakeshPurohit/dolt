# syntax=docker/dockerfile:1.3-labs

FROM debian:bookworm-slim AS base
RUN apt update -y && \
    apt install -y --no-install-recommends \
        curl \
        tini \
        ca-certificates && \
    apt clean && \
    rm -rf /var/lib/apt/lists/*


FROM golang:1.24-bookworm AS build-from-source
ARG DOLT_VERSION

# Copy doesn't support conditionals, so we rely on the path context to include dolt/ for source builds
COPY *dolt/ /tmp/dolt

RUN if [ "$DOLT_VERSION" = "source" ]; then \
        cd /tmp/dolt/go || { echo "Make sure the dolt/ directory exists in your workspace to build from source."; exit 1; }; \
        apt install -y && \
            git \
            libicu-dev && \
        apt clean && \
        rm -rf /var/lib/apt/lists/* && \
        go build -o /usr/local/bin/dolt ./cmd/dolt && \
        chmod +x /usr/local/bin/dolt; \
    fi


FROM base AS download-binary
ARG DOLT_VERSION
RUN if [ "$DOLT_VERSION" != "source" ]; then \
        [ "$DOLT_VERSION" = "latest" ] && \
            DOLT_VERSION=$(curl -s https://api.github.com/repos/dolthub/dolt/releases/latest \
                | grep '"tag_name"' \
                | cut -d'"' -f4 \
                | sed 's/^v//') && \
            echo "Resolved latest version: $DOLT_VERSION" || \
            echo "Using specified version: $DOLT_VERSION"; \
        curl -L "https://github.com/dolthub/dolt/releases/download/v${DOLT_VERSION}/install.sh" | bash; \
    fi


FROM base AS runtime
ARG DOLT_VERSION

COPY --from=download-binary /usr/local/bin/*dolt /usr/local/bin/
COPY --from=build-from-source /usr/local/bin/*dolt /usr/local/bin/

RUN if [ "$DOLT_VERSION" = "source" ]; then \
        apt-get update -y && \
        apt-get install -y \
            git \
            libicu-dev && \
        apt-get clean && \
        rm -rf /var/lib/apt/lists/*; \
    fi


RUN /usr/local/bin/dolt version

RUN mkdir /docker-entrypoint-initdb.d && \
    mkdir -p /var/lib/dolt && \
    chmod 755 /var/lib/dolt

COPY *docker/*docker-entrypoint.sh /usr/local/bin/
COPY *dolt/*docker/*docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

VOLUME /var/lib/dolt
EXPOSE 3306 33060
WORKDIR /var/lib/dolt
ENTRYPOINT ["tini", "--", "docker-entrypoint.sh"]
